var controllerList = {};
var ngControllerInit = function(controllerName, controller) {
    controllerList[controllerName] = controller;
};
var getTemplatePath = function(controllerName, controller) {
    controllerList[controllerName] = controller;
};

var copy = angular.copy;
var globalVar = {};
var app = angular.module('webapp', [
    'ngRoute',
    'ngAnimate'
]);

angular.element(document).ready(function() {

    // 引入jQuery
    app.factory('jQuery', [
        '$window',
        function ($window) {
            return $window.jQuery;
        }
    ]);
    // ng-repeat finished 指令
    app.directive('onFinishRender', function ($timeout) {
        return {
            restrict: 'A',
            link: function (scope, element, attr) {
                if (scope.$last === true) {
                    $timeout(function () {
                        scope.$emit(attr.onFinishRender);
                    });
                }
            }
        }
    });
    // 排序指令
    app.directive('sortOrderDirective', function (jQuery) {
        return {
            restrict: 'A',
            replace : true,
            scope: {
                title:'@',
                sortParams:'=',
                getData:'&getFunc',
            },
            template: '<th class="sort-th {{ classStr }}" ng-click="sortOrder()"><a href="javascript:void(0)">{{ title }}</a></th>',
            link: function (scope, element, attr) {
                scope.sortType = '';
                scope.classStr = 'sorting';
                scope.sortOrder = function(){
                    jQuery('.dataTable>thead>tr>.sort-th')
                        .removeClass('sorting_desc')
                        .removeClass('sorting_asc')
                        .addClass('sorting');
                    if (scope.sortType == 'ASC') {
                        scope.sortType = 'DESC';
                        scope.classStr = 'sorting_desc';
                    } else {
                        scope.sortType = 'ASC';
                        scope.classStr = 'sorting_asc';
                    }
                    scope.sortParams = {sortType : scope.sortType, sortColumn: attr.sortColumn};
                    scope.getData({sortParams: scope.sortParams});
                }
            }
        }
    });
    //双日历
    app.constant('dateRangePickerOptions', {
        autoUpdateInput: false,
        timePicker: true,
        timePicker24Hour: true,
        timePickerIncrement: 1,
        timePickerSeconds: true,
        locale: {
            format: 'YYYY-MM-DD HH:mm:ss',
            applyLabel: '确定',
            cancelLabel: '清除',
            customRangeLabel: 'Custom',
            daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
            opens: 'left',
            firstDay: 1,
        },
    });
    //单日历
    app.constant('singleDateRangePickerOptions', {
        autoUpdateInput: false,
        timePicker: true,
        timePicker24Hour: true,
        timePickerIncrement: 1,
        timePickerSeconds: true,
        singleDatePicker: true,
        locale: {
            format: 'YYYY-MM-DD HH:mm:ss',
            applyLabel: '确定',
            cancelLabel: '清除',
            customRangeLabel: 'Custom',
            daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
            opens: 'left',
            firstDay: 1,
        },
    });
});

/**
 * angularjs路由设置
 */
angular.element(document).ready(function() {
    var controllerPath = '/assets/pc/src/js/controllers/';
    var templatePath = '/assets/pc/src/views/';
    var app = angular.module('webapp');
    app.config(['$routeProvider', '$controllerProvider',
        function($routeProvider, $controllerProvider) {
            var routeMap = {
                '/index': {
                    view : 'pdf-to-img',
                    action : 'PdfController@PdfToImg',
                },
                '/pdf/to/img': {
                    view : 'pdf-to-img',
                    action : 'PdfController@PdfToImg',
                },
            };
            var defaultRoute = '/index';
            for (var key in routeMap) {
                var regexp = /^([a-zA-Z]+)@([a-zA-Z]+)$/;
                var match = routeMap[key].action.match(regexp);
                if (match) {
                    var controller = match[1];
                    var func = match[2];
                    var cpath = controllerPath;
                    $routeProvider.when(key, {
                        templateUrl: templatePath + routeMap[key].view + '.html?v=' + resourceVersion,
                        controller: controller + '_' + func,
                        resolve:{
                            keyName: requireModule(controller, func)
                        }
                    });
                }
            }
            $routeProvider.otherwise({redirectTo: defaultRoute});

            function requireModule(controller, func) {
                return function ($route, $q) {
                    var deferred = $q.defer();
                    if (controllerList[controller] != undefined) {
                        $controllerProvider.register(controller + '_' + func, controllerList[controller][func]);
                        deferred.resolve();
                    }
                    return deferred.promise;
                }
            }
            var $ = jQuery;
        }
    ]);
});

// 自动引导
angular.element(document).ready(function() {
    angular.bootstrap(document, ['webapp']);
});

(function($){
  // 定义辅助方法
  $.helper = {
    domain : "http://" + window.location.host,
    api : "http://" + window.location.host + "/api",
    upyunDomain : "http://flow_recharge.b0.upaiyun.com",
    url: function(path){
      var url = '';
       url = this.domain + "/" + path;
      return url;
    },
    asset : function(path) {
      var url = '';
      if (path == undefined) {
        url = this.domain;
      } else {
        url = this.domain + "/" + path;
      }
      return url;
    },
    upyun : function(path) {
      var url = '';
      if ($isLocal) {
        url = this.domain + "/" + path;
      } else {
        url = this.upyunDomain + "/" + path;
      }
      return url;
    },
    show: function($dom) {
      return $dom.removeClass('hidden').removeClass('hide').show();
    },
    hide: function($dom) {
      return $dom.removeClass('show').hide();
    },
    fadeIn: function($dom, $speed) {
      if ($speed == undefined) {
        $speed = 'normal';
      }
      $dom.fadeIn($speed).removeClass('hidden').removeClass('hide');
    },
    fadeOut: function($dom, $speed) {
      if ($speed == undefined) {
        $speed = 'normal';
      }
      $dom.removeClass('hidden').removeClass('hide').fadeOut($speed);
    },
    arrGet: function($arr, $column, $id) {
      var $item;
      $.each($arr, function(k, $val) {
        if ($val[$column] == $id) {
          $item = $val;
          return false;
        }
      });
      return $item;
    },
    alert: function($text, $type, $isAutoHide) {
      // 自定义alert
      var $tips = $('.js-alert-tips'),
          $textDom = $tips.find('.inner-text')
          $classText = 'alert-info alert-danger';
      $textDom.html($text);
      $textDom.removeClass($classText);
      $type = ($type == undefined) ? 1 : $type ;
      $isAutoHide = ($isAutoHide == undefined) ? true : $isAutoHide ;
      if ($type == 1) {
        // success alert
        $textDom.addClass('alert-info');
      } else if ($type == 2) {
        // danger alert
        $textDom.addClass('alert-danger');
      } else {
        $textDom.addClass('alert-info');
      }
      $.helper.fadeIn($tips);
      if ($isAutoHide != false) {
        setTimeout(function(){
          $tips.fadeOut();
        }, 5000);
      }
    },
    int2Chinese : function ($num) {
      // 将阿拉伯数字转换成中文数字
      var ary0 = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九"],
        ary1 =["", "十", "百", "千"],
        ary2 = ["", "万", "亿", "兆"],
        zero = "",
        newary = "",
        i4 = -1;

      if (! isNaN($num)) {
        // 不是数字
        $num = $num.toString();
      }
      // 倒转字符串。
      var $ary = [];
      for (var i = $num.length; i >= 0; i--) {
        $ary.push($num[i])
      }
      $ary = $ary.join("");

      // 处理
      for (var i = 0; i < $ary.length; i++) {
        if (i % 4 == 0) { //首先判断万级单位，每隔四个字符就让万级单位数组索引号递增
          i4++;
          newary = ary2[i4] + newary; //将万级单位存入该字符的读法中去，它肯定是放在当前字符读法的末尾，所以首先将它叠加入$r中，
          zero = ""; //在万级单位位置的“0”肯定是不用的读的，所以设置零的读法为空

        }
        //关于0的处理与判断。
        if ($ary[i] == '0') { //如果读出的字符是“0”，执行如下判断这个“0”是否读作“零”
          switch (i % 4) {
            case 0:
              break;
              //如果位置索引能被4整除，表示它所处位置是万级单位位置，这个位置的0的读法在前面就已经设置好了，所以这里直接跳过
            case 1:
            case 2:
            case 3:
              if ($ary[i - 1] != '0') {
                zero = "零"
              }; //如果不被4整除，那么都执行这段判断代码：如果它的下一位数字（针对当前字符串来说是上一个字符，因为之前执行了反转）也是0，那么跳过，否则读作“零”
              break;

          }

          newary = zero + newary;
          zero = '';
        } else { //如果不是“0”
          newary = ary0[parseInt($ary[i])] + ary1[i % 4] + newary; //就将该当字符转换成数值型,并作为数组ary0的索引号,以得到与之对应的中文读法，其后再跟上它的的一级单位（空、十、百还是千）最后再加上前面已存入的读法内容。
        }

      }
      if (newary.indexOf("零") == 0) {
        newary = newary.substr(1)
      } //处理前面的0
      return newary;
    }
  };
  // 定义共有变量
  $.cvar = {
    datatable: {
      config: {
        pageLength: 20,
        lengthChange: false,
        language: {
          search: '搜索：',
          searchPlaceholder: '请输入.....',
          emptyTable: '无记录',
          info: '显示_START_到_END_，共_TOTAL_行',
          infoEmpty: '',
          infoFiltered: '从_MAX_行记录中搜索',
          zeroRecords: '搜索无记录',
          paginate: {
            first: '首页',
            last: '最后一页',
            next: '下一页',
            previous: '上一页',
          },
        },
      }
    }
  };
})(window.jQuery || window.Zepto);

(function($){
  var func = {
    customAjax : function(options){
      // 快速ajax函数
      _beforePost = function($form){
        return $form.settings.beforePost($form);
      },
      _beforeSend = function($form){
        return $form.settings.beforeSend($form);
      },
      _success = function ($form, $data) {
        $form.settings.success($form, $data);
      },
      _post = function($form) {
        if (! _beforePost($form)) {
          return false;
        }
        if ($form.attr('method') != '') {
          $form.settings.type = $form.attr('method');
        }
        if ($form.settings.fileUpload && $form.data('file') != undefined) {
          var $file = $form.data('file');
          $form.find('.input-file').fileupload(
            'option',
            'type',
            $form.settings.type
          );
          $form.find('.btn-submit').button('loading');
          $file.submit().always(function() {
            $form.find('.btn-submit').button('reset');
          });
          return;
        }
        $.ajax({
          type: $form.settings.type,
          url: $form.attr('action'),
          dataType: 'json',
          data: $form.serialize(),
          beforeSend: function() {
            _beforeSend($form);
          },
          success: function($data) {
            _success($form, $data);
          },
          complete: function() {
            _complete($form);
          },
          error: function() {
            _error($form);
          }
        })
      },
      _complete = function($form) {
        $form.settings.complete($form);
      },
      _error = function(){
        $.helper.alert('系统错误，请稍后再试', 2);
      };

      return this.each(function(){
        var $this = $(this);
        var settings = {
          type : 'post',
          fileUpload: false,
          fileUploadOpts: {
            url: $this.attr('action'),
            //forceIframeTransport: true,
            //iframe: true,
            type: 'post',
            dataType: 'json',
            autoUpload: false,
            formAcceptCharset: 'utf-8',
            singleFileUploads: true,
            acceptFileTypes: /(\.|\/)(pdf)$/i,
            maxFileSize: 5000000, // 5 MB
            // Enable image resizing, except for Android and Opera,
            // which actually support image resizing, but fail to
            // send Blob objects via XHR requests:
            disableImageResize: /Android(?!.*Chrome)|Opera/
              .test(window.navigator.userAgent),
          },
          fileUploadFunc: {
            fileuploadadd: function(){},
            fileuploadstart: function($form, $e) {
              // 开始上传
              $.helper.show($form.find('.progress'));
              $form.find('.progress .progress-bar').css('width', 0);
            },
            fileuploadprogressall: function($form, $e, $data) {
              // 所有文件正在上传时
              var progress = parseInt($data.loaded / $data.total * 100, 10);
              $form.find('.progress .progress-bar').css(
                'width',
                progress + '%'
              );
            },
            fileuploaddone: function($form, $e, $data) {
              // 文件上传完毕
              if ($data.result['c'] == 0) {
                $.helper.alert($data.result['mesg'], 1);
              } else {
                $.helper.alert($data.result['mesg'], 2);
              }
            },
            fileuploadalways: function($form, $e, $data) {
              setTimeout(function(){
                $.helper.fadeOut($form.find('.progress'));
              }, 5000);
            },
            fileuploadfail: function($form, $e, $data) {
              // 文件上传失败
              $.helper.alert('网络错误，请重新操作', 2);
            },
          },
          beforePost : function($form){return true},
          beforeSend : function($form){
            $form.find('.btn-submit').button('loading');
          },
          success : function($form, $data) {
            if ($data['errcode'] == 0) {
              $.helper.alert('操作成功', 1);
            } else {
              $.helper.alert($data['errmsg'], 2);
            }
          },
          complete: function($form) {
            $form.find('.btn-submit').button('reset');
          },
        };
        if (options != undefined) {
            if (options.fileUploadOpts != undefined) {
                options.fileUploadOpts = $.fn.extend(settings.fileUploadOpts, options.fileUploadOpts);
            }
            if (options.fileUploadFunc != undefined) {
                options.fileUploadFunc = $.fn.extend(settings.fileUploadFunc, options.fileUploadFunc);
            }
        }
        $this.settings = $.fn.extend(settings, options);
        if ($this.settings.fileUpload) {
          // 附件上传js绑定
          $this.find('.input-file').fileupload($this.settings.fileUploadOpts);
          $.each($this.settings.fileUploadFunc, function($name, $func) {
            $this.find('.input-file')
              .on($name, function(e, data) {
                $func($this, e, data);
              });
          });
          $this.find('.input-file')
            .prop('disabled', !$.support.fileInput)
            .parent().addClass($.support.fileInput ? undefined : 'disabled');
        }
        $this.submit(function(e){
          e.preventDefault();
          _post($this);
        });

        return $this;
      });
    }
  };
  if ($.fn.extend == undefined) {
    $.extend(func);
  } else {
    $.fn.extend(func);
  }
})(window.jQuery || window.Zepto);


/**
 * pdf转图片
 * @author jason <numberjason@gamil.com>
 * @since 2017-06-05
 */
(function() {
    var Controller = {};
    /**
     * pdf转图片
     */
    PdfToImg.$inject = ['$scope', '$rootScope', '$location', '$route', 'jQuery', '$http'];
    function PdfToImg($scope, $rootScope, $location, $route, $, $http) {
        $rootScope.title = 'pdf转图片';
        $rootScope.baseUrl = baseUrl;
        //已完成
        $scope.showSuccess = function() {
            var toast = $('.js-show-success');
            if (toast.css('display') != 'none') {
                return;
            }
            toast.fadeIn(100);
            setTimeout(function () {
                toast.fadeOut(100);
            }, 2000);
        }
        //加载中
        $scope.showLoadingToast = function() {
            console.log('fuck');
            var loadingToast = $('.js-show-loading');
            if (loadingToast.css('display') != 'none') {
                return;
            }
            loadingToast.fadeIn(100);
            // setTimeout(function () {
            //     loadingToast.fadeOut(100);
            // }, 2000);
        }
        //预览pdf
        $scope.showLoadingPic = function() {
            let data = {
                type: 'num'
            }
            let loadingToast = $('.js-show-loading');
            $.ajax({
                url: baseUrl + 'api/pdf/to/img',
                type: 'post',
                dataType: 'json',
                data: data,
                beforeSend: function() {
                    if (loadingToast.css('display') != 'none') {
                        return;
                    }
                    loadingToast.fadeIn(100);
                },
                success: function(resp) {
                    for (let i = 1; i <= resp.data.num; i++) {
                        let item = '';
                        item += "<li class='weui-uploader__file js_"+i+"_img' style='background-image:url(/assets/pc/src/imgs/loading.gif)'></li>"
                        $('.imgs-parent').append(item);
                        $scope.showRaelPic(i);
                    }
                },
            });
        }
        //显示真正图片
        $scope.showRaelPic = function(num) {
            let data = {
                type: 'img',
                pic_no: num
            }
            let loadingToast = $('.js-show-loading');
            $.ajax({
                url: baseUrl + 'api/pdf/to/img',
                type: 'post',
                dataType: 'json',
                data: data,
                success: function(resp) {
                    if (num == 1) {
                        loadingToast.fadeOut(100);
                    }
                    $(".js_"+num+"_img").css("background-image", "url("+resp.data.realPath+")");
                },
            });
        }


        //预览pdf
        // $scope.showPic = function() {
        //     let data = {
        //         status: '1'
        //     }
        //     let toast = $('.js-show-success');
        //     let loadingToast = $('.js-show-loading');
        //     $.ajax({
        //         url: baseUrl + 'api/pdf/to/img',
        //         type: 'post',
        //         dataType: 'json',
        //         data: data,
        //         beforeSend: function() {
        //             if (loadingToast.css('display') != 'none') {
        //                 return;
        //             }
        //             loadingToast.fadeIn(100);
        //         },
        //         success: function(resp) {
        //             loadingToast.fadeOut(100);
        //             toast.fadeIn(100);
        //             setTimeout(function () {
        //                 toast.fadeOut(100);
        //             }, 2000);
        //             console.log(resp);
        //         },
        //     });
        // }
    }
    Controller['PdfToImg'] = PdfToImg;
    ngControllerInit('PdfController', Controller);
})();
